# Документация к проекту

<details>
<summary> Решаемая проблема + тонкости MVP</summary>
<div class="toggle-content">
Для демонстрации своих навыков решил смоделировать такую ситуацию. Человек записывает данные о своём сне. Атритбуты записи простые:
- Дата измерения
- Время подъёма
- Время отбоя

![изображение](./pictures/q.png)

Пользователь хочет получить аналитику своих данных, например чтобы оценить динамику изменений своего режима сна

### Цель продукта: предоставить пользователю аналитику его данных "из коробки"==быстро, просто и понятно   

Несколько замечаний:
- Данные не делал сильно разношёрстными, чтобы не усложнять разработку MVP
- Для данного MVP предполагается строгая схема входных данных 
</div>
</details>

<details>
<summary> Архитектура решения</summary>
<div class="toggle-content">

![изображение](./pictures/architecture.png)

- С локальной машины пользователь пробрасывает bind-mount, содержащий исследуемый csv-файл
- first_dag
  - Его задача: постоянный поиск файла-источника в bind-mount раз в 3 минуты
  - Если csv-файл нашёлся -> можно обновлять данные в postgres (=хранилище сырых данных) 
  - В случае успеха, он совершает update данных в postgres
- Second_dag
  - Его задача это доставка сырых данных в витрины данных (=плацдарм для дашборда)   
  - Он запускается также раз в 3 минуты, и начинается с сенсора:
    - Который показывает, произошли изменения в postgres или нет. Если нет -> дальше даг не пойдёт 
    - Сенсор работает по метаданным postgres: были или нет изменения в базе за последние 3 минуты 
 - Если всё-таки изменения случились, то даг, разделившись на две ветки, перезаписывает две витрины
     - Ветки делают truncate витрин + их полный перерасчет. ClickHouse'овское insert-only!
     - Далее идет сборка дашборда на графане по мотивам двух витрин 
- Витрины:
     - Предосталвяют множественный линейный график для отбоя, подъема и продолжительности сна + их плавающих значений 
     - А также динамику 3 основных метрик: подъем, отбой и продолжмтельность сна в разрезе по дням недели

  
_______________________________
Работа дага first_dag:

![изображение](./pictures/dag1.png)

</div>
</details>
